import{B as S}from"./AIStudio-DqOJjP3R.js";import"./index-Dt8YkMnR.js";import"./camera-Bpgv9Idn.js";import"./index-DE7d_UDx.js";import"./index-C32bg_6D.js";class E extends S{constructor(t={}){super(t),this.connections=[],this.canvas=null,this.mouseState={isDown:!1,lastX:0,lastY:0,rotationX:0,rotationY:0,scale:1,isDragging:!1,touchIdentifier:null},this.viewState={position:{x:0,y:0},isDraggingView:!1,dragStartPos:{x:0,y:0},isInitialized:!1},this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleWheel=this.handleWheel.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handlePointerDown=this.handlePointerDown.bind(this),this.handlePointerMove=this.handlePointerMove.bind(this),this.handlePointerUp=this.handlePointerUp.bind(this),this.initializeViewPosition=this.initializeViewPosition.bind(this)}updateConnectionsForModel(t){this.connections=t}updateConfig(t){this.config={...this.config,...t}}initializeViewPosition(t,e){if(!this.viewState.isInitialized){const s=Math.min(200,t*.25),n=s;this.viewState.position={x:t-s-16,y:(e-n)/2},this.viewState.isInitialized=!0}}get3DViewBounds(t,e){const s=Math.min(200,t*.25),n=s;return{x:this.viewState.position.x,y:this.viewState.position.y,width:s,height:n}}isInDragHeader(t,e,s,n){const i=this.get3DViewBounds(s,n);return t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+24}isInInteractionArea(t,e,s,n){const i=this.get3DViewBounds(s,n);return t>=i.x&&t<=i.x+i.width&&e>=i.y+24&&e<=i.y+i.height}renderPoses(t,e,s,n){const i=t.getContext("2d");if(!i||!e.poses||e.poses.length===0)return;this.canvas!==t&&(this.setupMouseEvents(t),this.canvas=t),t.width=s,t.height=n,i.clearRect(0,0,t.width,t.height);const o=this.video;if(!o)return;const a=s/o.videoWidth,h=n/o.videoHeight;let r=0,l=0;e.poses.forEach(c=>{if(c.keypoints){r+=c.keypoints.length;const m=c.keypoints.map(v=>{let d=v.x,u=v.y;d>=0&&d<=1&&u>=0&&u<=1?(d=d*t.width,u=u*t.height):(d=d*a,u=u*h);const f=v.score||v.visibility||1,g=isNaN(f)?!0:f>this.config.minConfidence,w=!isNaN(d)&&!isNaN(u)&&!(d===0&&u===0);return(!g||!w)&&l++,{...v,x:d,y:u}});this.drawKeypoints(i,m),this.drawSkeleton(i,m),this.config.showBoundingBox&&this.drawBoundingBox(i,m)}}),this.drawDetectionStatus(i,l,s)}drawDetectionStatus(t,e,s){if(e===0)return;const n=Math.min(450,s*.4),i=25,o=`${e} ${e===1?"point":"points"} not detected`;t.font="12px Arial";const a=t.measureText(o).width,h=8;t.fillStyle="rgba(220, 38, 38, 0.9)",t.fillRect(n-h,i-16,a+h*2,20),t.fillStyle="#ffffff",t.textAlign="left",t.fillText(o,n,i)}drawKeypoints(t,e){e.forEach(s=>{const n=s.score||s.visibility||1,i=isNaN(n)?!0:n>this.config.minConfidence,{x:o,y:a}=s,h=!isNaN(o)&&!isNaN(a)&&!(o===0&&a===0);if(i&&h&&(t.beginPath(),t.arc(o,a,this.config.keypointSize,0,2*Math.PI),t.fillStyle=this.config.keypointColor,t.fill(),this.config.showKeypointLabels)){t.fillStyle=this.config.keypointLabelColor,t.font=`${this.config.keypointLabelSize}px Arial`,t.textAlign="center";const r=s.name||s.part||`Point ${e.indexOf(s)}`;t.fillText(r,o,a-this.config.keypointSize-5)}})}drawSkeleton(t,e){t.strokeStyle=this.config.skeletonColor,t.lineWidth=this.config.skeletonThickness,this.connections.forEach(([s,n])=>{const i=e[s],o=e[n],a=i?.score||i?.visibility||1,h=o?.score||o?.visibility||1,r=isNaN(a)?!0:a>this.config.minConfidence,l=isNaN(h)?!0:h>this.config.minConfidence,c=!isNaN(i?.x)&&!isNaN(i?.y)&&!(i?.x===0&&i?.y===0),m=!isNaN(o?.x)&&!isNaN(o?.y)&&!(o?.x===0&&o?.y===0);i&&o&&r&&l&&c&&m&&(t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(o.x,o.y),t.stroke())})}setupMouseEvents(t){this.canvas&&(this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("mouseup",this.handleMouseUp),this.canvas.removeEventListener("wheel",this.handleWheel),this.canvas.removeEventListener("touchstart",this.handleTouchStart),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchend",this.handleTouchEnd),this.canvas.removeEventListener("pointerdown",this.handlePointerDown),this.canvas.removeEventListener("pointermove",this.handlePointerMove),this.canvas.removeEventListener("pointerup",this.handlePointerUp)),t.addEventListener("mousedown",this.handleMouseDown),t.addEventListener("mousemove",this.handleMouseMove),t.addEventListener("mouseup",this.handleMouseUp),t.addEventListener("wheel",this.handleWheel,{passive:!1}),t.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),t.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),t.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),t.addEventListener("pointerdown",this.handlePointerDown),t.addEventListener("pointermove",this.handlePointerMove),t.addEventListener("pointerup",this.handlePointerUp),t.addEventListener("contextmenu",e=>e.preventDefault())}handleMouseDown(t){const e=t.target.getBoundingClientRect(),s=t.clientX-e.left,n=t.clientY-e.top,i=t.target,o=i.width,a=i.height;this.initializeViewPosition(o,a),this.isInDragHeader(s,n,o,a)?(this.viewState.isDraggingView=!0,this.viewState.dragStartPos={x:t.clientX-this.viewState.position.x,y:t.clientY-this.viewState.position.y},i.style.cursor="grabbing"):this.isInInteractionArea(s,n,o,a)&&(this.mouseState.isDown=!0,this.mouseState.isDragging=!0,this.mouseState.lastX=s,this.mouseState.lastY=n,i.style.cursor="grabbing")}handleMouseMove(t){const e=t.target;if(this.viewState.isDraggingView){const s=t.clientX-this.viewState.dragStartPos.x,n=t.clientY-this.viewState.dragStartPos.y,i=this.get3DViewBounds(e.width,e.height),o=e.width-i.width,a=e.height-i.height;this.viewState.position={x:Math.max(0,Math.min(s,o)),y:Math.max(0,Math.min(n,a))}}else if(this.mouseState.isDown&&this.mouseState.isDragging){const s=e.getBoundingClientRect(),n=t.clientX-s.left,i=t.clientY-s.top,o=n-this.mouseState.lastX,a=i-this.mouseState.lastY;this.mouseState.rotationY+=o*.01,this.mouseState.rotationX+=a*.01,this.mouseState.lastX=n,this.mouseState.lastY=i}}handleMouseUp(t){this.mouseState.isDown=!1,this.mouseState.isDragging=!1,this.viewState.isDraggingView=!1;const e=t.target;e.style.cursor="grab"}handleWheel(t){t.preventDefault();const e=t.target,s=e.getBoundingClientRect(),n=t.clientX-s.left,i=t.clientY-s.top;if(this.initializeViewPosition(e.width,e.height),this.isInInteractionArea(n,i,e.width,e.height)){const o=t.deltaY>0?.9:1.1;this.mouseState.scale=Math.max(.5,Math.min(3,this.mouseState.scale*o))}}handleTouchStart(t){if(t.preventDefault(),t.touches.length===1){const e=t.touches[0],s=t.target,n=s.getBoundingClientRect(),i=e.clientX-n.left,o=e.clientY-n.top;this.initializeViewPosition(s.width,s.height),this.isInDragHeader(i,o,s.width,s.height)?(this.viewState.isDraggingView=!0,this.viewState.dragStartPos={x:e.clientX-this.viewState.position.x,y:e.clientY-this.viewState.position.y},s.style.cursor="grabbing"):this.isInInteractionArea(i,o,s.width,s.height)&&(this.mouseState.isDown=!0,this.mouseState.isDragging=!0,this.mouseState.lastX=i,this.mouseState.lastY=o,this.mouseState.touchIdentifier=e.identifier,s.style.cursor="grabbing")}}handleTouchMove(t){if(t.preventDefault(),!this.mouseState.isDragging||t.touches.length!==1)return;const e=Array.from(t.touches).find(r=>r.identifier===this.mouseState.touchIdentifier);if(!e)return;const n=t.target.getBoundingClientRect(),i=e.clientX-n.left,o=e.clientY-n.top,a=i-this.mouseState.lastX,h=o-this.mouseState.lastY;this.mouseState.rotationY+=a*.008,this.mouseState.rotationX+=h*.008,this.mouseState.lastX=i,this.mouseState.lastY=o}handleTouchEnd(t){t.preventDefault(),this.mouseState.isDown=!1,this.mouseState.isDragging=!1,this.mouseState.touchIdentifier=null;const e=t.target;e.style.cursor="grab"}handlePointerDown(t){if(!t.isPrimary)return;const e=t.target,s=e.getBoundingClientRect(),n=t.clientX-s.left,i=t.clientY-s.top,o=e.width,a=e.height,h=Math.min(o*.35,a*.45),r=h,l=o-h-20,c=(a-r)/2;n>=l&&n<=l+h&&i>=c&&i<=c+r&&(this.mouseState.isDown=!0,this.mouseState.isDragging=!0,this.mouseState.lastX=n,this.mouseState.lastY=i,e.style.cursor="grabbing",e.setPointerCapture(t.pointerId))}handlePointerMove(t){if(!this.mouseState.isDragging||!t.isPrimary)return;const s=t.target.getBoundingClientRect(),n=t.clientX-s.left,i=t.clientY-s.top,o=n-this.mouseState.lastX,a=i-this.mouseState.lastY,h=t.pointerType==="pen"?.015:.01;this.mouseState.rotationY+=o*h,this.mouseState.rotationX+=a*h,this.mouseState.lastX=n,this.mouseState.lastY=i}handlePointerUp(t){if(!t.isPrimary)return;this.mouseState.isDown=!1,this.mouseState.isDragging=!1;const e=t.target;e.style.cursor="grab",e.releasePointerCapture(t.pointerId)}drawBoundingBox(t,e){const s=e.filter(g=>{const w=g.score||g.visibility||1;return!isNaN(w)&&w>this.config.minConfidence&&!isNaN(g.x)&&!isNaN(g.y)});if(s.length===0)return;const n=s.map(g=>g.x),i=s.map(g=>g.y),o=Math.min(...n),a=Math.max(...n),h=Math.min(...i),r=Math.max(...i),l=10,c=o-l,m=a+l,v=h-l,d=r+l,u=m-c,f=d-v;t.strokeStyle=this.config.boundingBoxColor,t.lineWidth=this.config.boundingBoxThickness,t.strokeRect(c,v,u,f)}dispose(){this.canvas&&(this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("mouseup",this.handleMouseUp),this.canvas.removeEventListener("wheel",this.handleWheel),this.canvas.removeEventListener("touchstart",this.handleTouchStart),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchend",this.handleTouchEnd),this.canvas.removeEventListener("pointerdown",this.handlePointerDown),this.canvas.removeEventListener("pointermove",this.handlePointerMove),this.canvas.removeEventListener("pointerup",this.handlePointerUp),this.canvas.style.cursor="default"),super.dispose()}}export{E as PoseDetection3DProvider};
